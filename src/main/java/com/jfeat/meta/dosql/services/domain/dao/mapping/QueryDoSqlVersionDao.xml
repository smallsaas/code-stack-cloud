<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jfeat.meta.dosql.services.domain.dao.QueryDoSqlVersionDao">
    <sql id="Base_Column_List">
        t_dev_version.id,
        t_dev_version.sql_version AS sqlVersion,
        t_dev_version.appid,
        t_dev_version.note,
        t_dev_version.create_time AS createTime,
        t_dev_version.update_time AS updateTime
    </sql>


    <select id="queryMasterModel" resultType="DevVersionModel">
        SELECT t_dev_version.*
        FROM t_dev_version
        WHERE t_dev_version.id = #{id}
        GROUP BY t_dev_version.id
    </select>


    <select id="findDevVersionPage" resultType="DevVersionRecord" parameterType="DevVersionRecord">
        SELECT
        <include refid="Base_Column_List"/>


        FROM t_dev_version


        WHERE 1=1


        <if test="record.id != null and record.id>0 ">
            AND t_dev_version.id LIKE CONCAT('%',#{record.id},'%')
        </if>


        <if test="record.sqlVersion != null and record.sqlVersion!= ''">
            AND t_dev_version.sql_version LIKE CONCAT('%',#{record.sqlVersion},'%')
        </if>
        <if test="record.appid != null and record.appid!= ''">
            AND t_dev_version.appid LIKE CONCAT('%',#{record.appid},'%')
        </if>
        <if test="record.note != null and record.note!= ''">
            AND t_dev_version.note LIKE CONCAT('%',#{record.note},'%')
        </if>


        <if test="record.createTime != null and record.createTime>0 ">
            AND t_dev_version.create_time LIKE CONCAT('%',#{record.createTime},'%')
        </if>


        <if test="record.updateTime != null and record.updateTime>0 ">
            AND t_dev_version.update_time LIKE CONCAT('%',#{record.updateTime},'%')
        </if>

        <if test="startTime != null">
            <![CDATA[AND t_dev_version.start_time >= DATE(#{startTime})]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_dev_version.end_time <= DATE(#{endTime}]]>
        </if>
        <!--
    <if test="search != null and search != ''">
        OR t_dev_version.name LIKE CONCAT('%',#{search},'%')
    </if>
    -->
        ORDER BY update_time DESC
        , create_time DESC
    </select>

    <resultMap id="DevVersionRecordMap" type="DevVersionRecord">
        <id column="id" property="id" />
        <result column="sqlVersion" property="sqlVersion" />
        <result column="appid" property="appid" />
        <result column="note" property="note" />
        <result column="createTime" property="createTime" />
        <result column="updateTime" property="updateTime" />
        <collection property="devDevelopList" ofType="com.jfeat.meta.dosql.services.gen.persistence.model.DoSqlField" select="devVersionsSubquery" column="sqlVersion">
            <id column="id" property="id" />
            <result column="title" property="title" />
            <result column="description" property="description" />
            <result column="query_file_name" property="queryFileName" />
            <result column="execution_file_name" property="executionFileName" />
            <result column="param_status" property="paramStatus" />
            <result column="sql_version" property="sqlVersion" />
            <result column="note" property="note" />
            <result column="create_time" property="createTime" />
            <result column="update_time" property="updateTime" />
        </collection>
    </resultMap>


    <select id="queryVersionDetail" resultMap="DevVersionRecordMap" parameterType="DevVersionRecord">
        SELECT
        <include refid="Base_Column_List"/>


        FROM t_dev_version


        WHERE 1=1


        <if test="record.id != null and record.id>0 ">
            AND t_dev_version.id =#{record.id}
        </if>


        <if test="record.sqlVersion != null and record.sqlVersion!= ''">
            AND t_dev_version.sql_version LIKE CONCAT('%',#{record.sqlVersion},'%')
        </if>
        <if test="record.appid != null and record.appid!= ''">
            AND t_dev_version.appid LIKE CONCAT('%',#{record.appid},'%')
        </if>
        <if test="record.note != null and record.note!= ''">
            AND t_dev_version.note LIKE CONCAT('%',#{record.note},'%')
        </if>


        <if test="record.createTime != null and record.createTime>0 ">
            AND t_dev_version.create_time LIKE CONCAT('%',#{record.createTime},'%')
        </if>


        <if test="record.updateTime != null and record.updateTime>0 ">
            AND t_dev_version.update_time LIKE CONCAT('%',#{record.updateTime},'%')
        </if>

        <!--
    <if test="search != null and search != ''">
        OR t_dev_version.name LIKE CONCAT('%',#{search},'%')
    </if>
    -->
        ORDER BY t_dev_version.sort_number DESC ,t_dev_version.update_time DESC
        ,t_dev_version create_time DESC
    </select>

    <select id="devVersionsSubquery" resultType="com.jfeat.meta.dosql.services.gen.persistence.model.DoSqlField">
        SELECT t_dev_develop.*
        FROM t_dev_develop where t_dev_develop.sql_version=#{sqlVersion}
    </select>

</mapper>